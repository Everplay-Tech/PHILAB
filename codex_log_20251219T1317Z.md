# PhiLab Session Log (2025-12-19T13:17Z)

## Repository
- Root: /Users/magus/PHILAB_repo
- Primary focus: PhiLab geometry/experiments (Phi-2) with WordNet/epistemology probing, telemetry, and Atlas logging.

## High-level outcomes
- Added Apache 2.0 license.
- Hardened telemetry (status endpoint, logging, empty states), aligned geometry paths, added healthcheck.
- Switched defaults to real model (`use_mock: false`).
- Built full-layer/head probes for epistemology (true/false) and WordNet semantic relations; added sanity variants.
- Added WordNet authority map, dump script with pillars/limits/version enforcement, metadata outputs.
- Added runtime presets, caps, manifests, and Atlas logging with semantic code registration; auto-ingest geometry telemetry into Atlas.
- Added CI (smoke, WordNet shape check, mock telemetry, mock run_experiment; GPU e2e stub).
- Added rate limiting (in-memory with optional Redis), config validation, Atlas ingestion/query/UI scripts, contributor guidance, and GPU-friendly presets.

## Detailed change log

### Licensing and config defaults
- Added `LICENSE` (Apache 2.0).
- Set `model.use_mock: false` in `phi2_lab/config/app.yaml`.
- Added `phi2_lab/config/presets.yaml` (cpu_sanity, mps_fast, gpu_starter, gpu_expert, gpu_full) with limits, max_length, batch_size.

### Geometry/telemetry
- Logging for skipped telemetry runs/residual sampler fallback.
- `/api/geometry/status` endpoint added.
- Dashboard empty-state messaging when no runs.
- Healthcheck script seeds mock run and reports status: `phi2_lab/scripts/geometry_healthcheck.py`.
- Telemetry auto-ingested into Atlas on finalize (includes per-layer entries).

### Probes and datasets
- Epistemology probe: expanded true/false dataset `phi2_lab/data/epistemology_true_false.jsonl`; spec `phi2_lab/config/experiments/epistemology_probe.yaml` covers all layers/heads (self_attn+mlp).
- Semantic relations (WordNet 3.1):
  - Canonical relations/pointers `phi2_lab/resources/wordnet_relations.json` with loader (`resources/__init__.py`).
  - Dump script `phi2_lab/scripts/build_wordnet_relations.py`:
    - Pillar filters, per-relation limits.
    - Enforces WordNet version 3.1 (aborts otherwise).
    - Writes metadata (.meta.json) with version, pillar, limits, counts, sha; errors on empty output.
  - Full probe spec `phi2_lab/config/experiments/semantic_relations_probe.yaml` (all layers/heads).
  - Sanity probe spec `phi2_lab/config/experiments/semantic_relations_sanity.yaml` (reduced layers/heads).
  - Suite runner `phi2_lab/scripts/run_telemetry_suite.py` selects full vs sanity (`--semantic-level`).

### Runtime controls and manifests
- Added CLI caps: `--limit-records/--limit-layers/--limit-heads`, `--max-length`, `--batch-size`; `--preset` pulls from presets.yaml.
- Tokenizer respects `max_length`; baseline batching uses `batch_size`.
- Run manifests (in metadata) include spec/dataset SHA256, model config, limits.

### Atlas integration
- `run_experiment.py` logs experiments to Atlas (optional tags/note, disable flag, snapshot output) and supports Atlas snapshots.
- Runner auto-registers semantic codes for WordNet (`wordnet::...`) and epistemology (`epistemology::...`).
- Geometry telemetry auto-ingested into Atlas on finalize (per-layer entries).
- Scripts:
  - Ingest telemetry: `phi2_lab/scripts/ingest_geometry_telemetry.py`
  - Atlas snapshot (grouped): `phi2_lab/scripts/build_atlas_snapshot.py`
  - Atlas query CLI: `phi2_lab/scripts/atlas_query.py`
  - Atlas UI (read-only FastAPI): `phi2_lab/scripts/serve_atlas_ui.py`

### WordNet authority and validation
- `phi2_lab/resources/wordnet_relations.json` (authority WordNet 3.1, pointers).
- Dump script enforces 3.1, emits metadata; warns/fails on mismatch.
- Contributor instructions to install nltk wordnet/omw before dumping.
- Config validation: `phi2_lab/utils/schema_validation.py`, invoked in `run_experiment.py` and `serve_geometry_dashboard.py`.

### Rate limiting and monitoring
- Geometry API: in-memory enforced limits with optional Redis backend (`PHILAB_REDIS_URL`), configurable via env (`PHILAB_RATE_LIMIT_*`, `PHILAB_RATE_LIMIT_WINDOW`). 429 on exceed.

### CI
- `.github/workflows/ci.yml`:
  - Installs deps + nltk.
  - Runs smoke tests.
  - WordNet shape check (pillar taxonomy limited) with metadata.
  - Mock geometry healthcheck + telemetry presence.
  - `run_experiment` mock sanity (`--preset cpu_sanity`).
  - GPU e2e job stub for real-model head ablation (requires self-hosted GPU runner/weights).

### Tests
- `tests/test_smoke.py`: resource/spec loading, dataset limits, WordNet resource, epoxy dataset.
- All tests passing locally: `PYTHONPATH=. .venv/bin/pytest -q tests/test_smoke.py`.

### Docs/guides
- README updated with semantic probes, caps, presets, Atlas flags, Atlas UI/query/ingest usage.
- Contributor guide `CONTRIBUTING_RUNS.md`: tiered runs, WordNet corpus install, pillar examples, caps, presets, GPU guidance.
- Session summaries: `codex_summary_2025-12-18T2025Z.md`, current log.

### Key files added/changed (high level)
- Licenses/Docs: `LICENSE`, `codex_summary_*.md`, `CONTRIBUTING_RUNS.md`, `README.md`, `TODO_enterprise_20251219T0630Z.md`.
- Config: `phi2_lab/config/app.yaml` (use_mock false), `phi2_lab/config/presets.yaml`, experiment specs (epistemology, semantic relations + sanity).
- Data/Resources: expanded `epistemology_true_false.jsonl`, `phi2_lab/resources/wordnet_relations.json`.
- Scripts: run_experiment (caps, Atlas, presets, snapshot), telemetry suite, healthcheck, geometry_to_telemetry, build_wordnet_relations, ingest_geometry_telemetry, atlas_query, serve_atlas_ui, build_atlas_snapshot (grouped), run_telemetry_suite (semantic-level).
- Runner: manifests, Atlas auto-ingest, caps, batching, max_length.
- API: geometry rate limiting (in-memory/Redis).
- CI: `.github/workflows/ci.yml`.
- Validation: `phi2_lab/utils/validation.py`, `schema_validation.py`.
- Tests: `tests/test_smoke.py`, package data updates.

## How to run (real model, public-ready)
1) Ensure nltk WordNet corpus: `python -c "import nltk; nltk.download('wordnet'); nltk.download('omw-1.4')"`
2) Build WordNet relations: `python phi2_lab/scripts/build_wordnet_relations.py --output results/datasets/wordnet_relations.jsonl` (fails if not 3.1).
3) Run experiments with presets/caps and Atlas logging:
   ```bash
   python phi2_lab/scripts/run_experiment.py \
     --spec phi2_lab/config/experiments/semantic_relations_probe.yaml \
     --geometry-telemetry \
     --preset gpu_starter \
     --atlas-tags wordnet
   ```
   Presets: cpu_sanity | mps_fast | gpu_starter | gpu_expert | gpu_full; caps override with `--limit-*`, `--max-length`, `--batch-size`.
4) Serve dashboard: `python phi2_lab/scripts/serve_geometry_dashboard.py` and check `/api/geometry/status`.
5) Atlas:
   - Ingest telemetry: `python phi2_lab/scripts/ingest_geometry_telemetry.py --runs-root results/geometry_viz`
   - Query: `python phi2_lab/scripts/atlas_query.py --search-codes --tag wordnet`
   - UI: `python phi2_lab/scripts/serve_atlas_ui.py --port 8001`

## Remaining considerations
- GPU e2e CI job requires a self-hosted GPU runner and Phi-2 weights.
- Rate limiting is per-process unless Redis is configured (PHILAB_REDIS_URL).
- Full sweeps are heavy; presets/caps help, but contributors should choose accordingly.

---
Codex
